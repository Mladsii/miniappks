<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>1–° –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; background: #f0f0f0; }
    #chat { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    input { width: 70%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 12px 20px; background: #0088cc; color: white; border: none; border-radius: 8px; margin-left: 10px; }
    a { color: #0088cc; font-weight: 500; }
  </style>
</head>
<body>
  <div id="chat">–ü—Ä–∏–≤–µ—Ç! –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ 1–°, –∏ —è –ø–æ–∫–∞–∂—É –Ω—É–∂–Ω–æ–µ –≤–∏–¥–µ–æ.</div>
  <input type="text" id="prompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º?">
  <button onclick="ask()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>
  async function ask() {
    const query = document.getElementById("prompt").value;
    if (!query.trim()) return;

    const N8N_WEBHOOK_URL = "https://n8nai-agentmmi.ru/webhook/3c9f0d22-584d-4297-b2e4-f9feaae43148";

    try {
      const response = await fetch(N8N_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: query })
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);

      const data = await response.json();

      // üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—à–ª–∏ –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è
      console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);

      // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç undefined/null
      const answer = data.answer || "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.";
      const videoUrl = (data.video_url || "").trim(); // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
      const startSec = parseInt(data.start_time_sec) || 0; // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —á–∏—Å–ª—É

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
      const minutes = Math.floor(startSec / 60);
      const seconds = (startSec % 60).toString().padStart(2, '0');
      const timeStr = `${minutes}:${seconds}`;

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É —Å —Ç–∞–π–º–∫–æ–¥–æ–º
      const videoLink = `${videoUrl}#t=${startSec}`;

      // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç
      document.getElementById("chat").innerHTML += `
        <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee">
          <div><b>–í—ã:</b> ${query}</div>
          <div style="margin-top:8px"><b>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:</b> ${answer}</div>
          <div style="margin-top:8px">‚ñ∂Ô∏è <a href="${videoLink}" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ —Å ${timeStr}</a></div>
        </div>
      `;
      document.getElementById("prompt").value = "";
    } catch (e) {
      document.getElementById("chat").innerHTML += `<div style="color:red">–û—à–∏–±–∫–∞: ${e.message}</div>`;
    }
  }
</script>

</body>
</html>